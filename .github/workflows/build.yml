name: Build

on:
  pull_request:
  push:
  workflow_call:

# TODO: add separate jobs for building, linting, and testing c++
jobs:
  prebuilt-test:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - uses: actions/setup-go@v4
        with:
          go-version: '1.20.x'
          check-latest: true

      - run: go clean -cache && go build ./...

      - run: go test -count=1 ./...

  build-lint-test:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - uses: actions/setup-go@v4
        with:
          go-version: '1.20.x'
          check-latest: true

      - if: ${{ 'macos-latest' == matrix.os }}
        run: |
          brew update
          brew install llvm

      - name: Remove repo's generated c++ libraries and go code
        run: |
          rm ./lib/* ./**/*_string.go

      - run: |
          go install mvdan.cc/gofumpt@latest
          go install github.com/segmentio/golines@latest
          go install golang.org/x/tools/cmd/stringer@latest

      - run: go clean -cache && go generate ./...

      - run: |
          diff="$(golines -m 100 -t 4 --base-formatter='gofumpt' --dry-run .)"
          if [[ -n "$diff"  ]]; then echo "$diff"; exit 1; fi

      # - run: cmake -S ./cpp -B ./cpp/build -DCMAKE_EXPORT_COMPILE_COMMANDS=1

      - run: go test -count=1 ./...
